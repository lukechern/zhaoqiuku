<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½•éŸ³æƒé™æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>

<body>
    <h1>WebView å½•éŸ³æƒé™æµ‹è¯•</h1>

    <div id="status" class="status info">
        ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æµ‹è¯•å½•éŸ³æƒé™
    </div>

    <button id="testBtn" onclick="testAudioPermission()">æµ‹è¯•å½•éŸ³æƒé™</button>
    <button id="startRecordBtn" onclick="startRecording()" disabled>å¼€å§‹å½•éŸ³</button>
    <button id="stopRecordBtn" onclick="stopRecording()" disabled>åœæ­¢å½•éŸ³</button>
    <button onclick="checkSystemInfo()">é‡æ–°æ£€æµ‹ç³»ç»Ÿ</button>
    <button onclick="checkPermissionStatus()">æ£€æŸ¥æƒé™çŠ¶æ€</button>

    <div id="log" style="margin-top: 20px; padding: 10px; background-color: #f5f5f5; border-radius: 4px;">
        <h3>æ—¥å¿—:</h3>
        <div id="logContent"></div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];

        function log(message) {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logContent.scrollTop = logContent.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        async function testAudioPermission() {
            log('å¼€å§‹æµ‹è¯•å½•éŸ³æƒé™...');
            updateStatus('æ­£åœ¨è¯·æ±‚å½•éŸ³æƒé™...', 'info');

            try {
                // æ£€æµ‹WebViewç¯å¢ƒ
                const isWebView = /Android.*wv\)|.*WebView.*Android|WebView|wv/i.test(navigator.userAgent);
                log(`ç¯å¢ƒæ£€æµ‹: ${isWebView ? 'WebView' : 'æ™®é€šæµè§ˆå™¨'}`);

                // è¯·æ±‚éº¦å…‹é£æƒé™ï¼ŒWebViewä½¿ç”¨ç®€åŒ–é…ç½®
                const constraints = isWebView ? {
                    audio: true
                } : {
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    }
                };

                log('è¯·æ±‚æƒé™é…ç½®: ' + JSON.stringify(constraints));

                const stream = await navigator.mediaDevices.getUserMedia(constraints);

                log('âœ… å½•éŸ³æƒé™è·å–æˆåŠŸï¼');
                log(`éŸ³é¢‘è½¨é“æ•°é‡: ${stream.getAudioTracks().length}`);

                // æ£€æŸ¥éŸ³é¢‘è½¨é“çŠ¶æ€
                const audioTrack = stream.getAudioTracks()[0];
                if (audioTrack) {
                    log(`éŸ³é¢‘è½¨é“çŠ¶æ€: ${audioTrack.readyState}`);
                    log(`éŸ³é¢‘è½¨é“è®¾ç½®: ${JSON.stringify(audioTrack.getSettings())}`);
                }

                updateStatus('å½•éŸ³æƒé™è·å–æˆåŠŸï¼å¯ä»¥å¼€å§‹å½•éŸ³', 'success');

                // å¯ç”¨å½•éŸ³æŒ‰é’®
                document.getElementById('startRecordBtn').disabled = false;

                // åœæ­¢æµï¼ˆæˆ‘ä»¬åªæ˜¯æµ‹è¯•æƒé™ï¼‰
                stream.getTracks().forEach(track => track.stop());

            } catch (error) {
                log(`âŒ å½•éŸ³æƒé™è·å–å¤±è´¥: ${error.name} - ${error.message}`);
                updateStatus(`å½•éŸ³æƒé™è·å–å¤±è´¥: ${error.message}`, 'error');

                // è¯¦ç»†é”™è¯¯åˆ†æ
                if (error.name === 'NotAllowedError') {
                    log('ğŸ” é”™è¯¯åˆ†æ: æƒé™è¢«æ‹’ç»');
                    log('è§£å†³æ–¹æ¡ˆ: 1. æ£€æŸ¥åº”ç”¨æ˜¯å¦æœ‰éº¦å…‹é£æƒé™ 2. æ£€æŸ¥WebViewæƒé™é…ç½®');
                } else if (error.name === 'NotFoundError') {
                    log('ğŸ” é”™è¯¯åˆ†æ: æœªæ‰¾åˆ°éŸ³é¢‘è¾“å…¥è®¾å¤‡');
                    log('è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥è®¾å¤‡æ˜¯å¦æœ‰éº¦å…‹é£ç¡¬ä»¶');
                } else if (error.name === 'NotSupportedError') {
                    log('ğŸ” é”™è¯¯åˆ†æ: æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½');
                    log('è§£å†³æ–¹æ¡ˆ: æ›´æ–°WebViewç‰ˆæœ¬æˆ–æ£€æŸ¥APIæ”¯æŒ');
                } else if (error.name === 'NotReadableError') {
                    log('ğŸ” é”™è¯¯åˆ†æ: æ— æ³•è®¿é—®éŸ³é¢‘è®¾å¤‡ï¼ˆå¸¸è§WebViewé—®é¢˜ï¼‰');
                    log('è§£å†³æ–¹æ¡ˆ: 1. æ·»åŠ MODIFY_AUDIO_SETTINGSæƒé™ 2. æ£€æŸ¥ç¡¬ä»¶ç‰¹æ€§å£°æ˜ 3. ç¡®ä¿WebViewæƒé™æ­£ç¡®é…ç½®');
                    log('è¯¦ç»†é…ç½®è¯·å‚è€ƒ: https://your-domain.com/document/webview-setup.md');
                } else {
                    log(`ğŸ” æœªçŸ¥é”™è¯¯: ${error.name}`);
                }
            }
        }

        async function startRecording() {
            log('å¼€å§‹å½•éŸ³...');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: true
                });

                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    log(`å½•éŸ³å®Œæˆï¼Œæ–‡ä»¶å¤§å°: ${audioBlob.size} å­—èŠ‚`);
                    updateStatus('å½•éŸ³å®Œæˆ', 'success');

                    // åœæ­¢æ‰€æœ‰éŸ³é¢‘è½¨é“
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                log('âœ… å½•éŸ³å·²å¼€å§‹');
                updateStatus('æ­£åœ¨å½•éŸ³...', 'info');

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('startRecordBtn').disabled = true;
                document.getElementById('stopRecordBtn').disabled = false;

            } catch (error) {
                log(`âŒ å¼€å§‹å½•éŸ³å¤±è´¥: ${error.name} - ${error.message}`);
                updateStatus(`å¼€å§‹å½•éŸ³å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                log('åœæ­¢å½•éŸ³');

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('startRecordBtn').disabled = false;
                document.getElementById('stopRecordBtn').disabled = true;
            }
        }

        function checkSystemInfo() {
            log('=== ç³»ç»Ÿä¿¡æ¯æ£€æµ‹ ===');
            log('ç”¨æˆ·ä»£ç†: ' + navigator.userAgent);

            // WebViewæ£€æµ‹
            const isWebView = /Android.*wv\)|.*WebView.*Android|WebView|wv/i.test(navigator.userAgent);
            log(`WebViewç¯å¢ƒ: ${isWebView ? 'æ˜¯' : 'å¦'}`);

            // APIæ”¯æŒæ£€æµ‹
            log(`navigator.mediaDevices: ${!!navigator.mediaDevices}`);
            log(`getUserMedia: ${!!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)}`);
            log(`MediaRecorder: ${!!window.MediaRecorder}`);

            // æƒé™APIæ£€æµ‹
            log(`Permissions API: ${!!navigator.permissions}`);

            // å®‰å…¨ä¸Šä¸‹æ–‡æ£€æµ‹
            log(`å®‰å…¨ä¸Šä¸‹æ–‡ (HTTPS): ${window.isSecureContext}`);
            log(`åè®®: ${window.location.protocol}`);

            // Chromeç‰ˆæœ¬æ£€æµ‹ï¼ˆWebViewåŸºäºChromeï¼‰
            const chromeMatch = navigator.userAgent.match(/Chrome\/(\d+)/);
            if (chromeMatch) {
                log(`Chromeç‰ˆæœ¬: ${chromeMatch[1]}`);
            }

            log('=== æ£€æµ‹å®Œæˆ ===');
        }

        async function checkPermissionStatus() {
            if (!navigator.permissions) {
                log('æµè§ˆå™¨ä¸æ”¯æŒæƒé™æŸ¥è¯¢API');
                return;
            }

            try {
                const result = await navigator.permissions.query({ name: 'microphone' });
                log(`éº¦å…‹é£æƒé™çŠ¶æ€: ${result.state}`);

                result.addEventListener('change', () => {
                    log(`æƒé™çŠ¶æ€å˜æ›´ä¸º: ${result.state}`);
                });
            } catch (error) {
                log(`æƒé™æŸ¥è¯¢å¤±è´¥: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            log('é¡µé¢åŠ è½½å®Œæˆ');

            // ç³»ç»Ÿä¿¡æ¯æ£€æµ‹
            checkSystemInfo();

            // æƒé™çŠ¶æ€æ£€æŸ¥
            checkPermissionStatus();

            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒ getUserMedia API');
                updateStatus('æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½', 'error');
                document.getElementById('testBtn').disabled = true;
            } else {
                log('âœ… æµè§ˆå™¨æ”¯æŒ getUserMedia API');
            }
        });
    </script>
</body>

</html>