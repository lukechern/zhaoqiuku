<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>录音权限测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>

<body>
    <h1>WebView 录音权限测试</h1>

    <div id="status" class="status info">
        点击下面的按钮测试录音权限
    </div>

    <button id="testBtn" onclick="testAudioPermission()">测试录音权限</button>
    <button id="startRecordBtn" onclick="startRecording()" disabled>开始录音</button>
    <button id="stopRecordBtn" onclick="stopRecording()" disabled>停止录音</button>
    <button onclick="checkSystemInfo()">重新检测系统</button>
    <button onclick="checkPermissionStatus()">检查权限状态</button>

    <div id="log" style="margin-top: 20px; padding: 10px; background-color: #f5f5f5; border-radius: 4px;">
        <h3>日志:</h3>
        <div id="logContent"></div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];

        function log(message) {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logContent.scrollTop = logContent.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        async function testAudioPermission() {
            log('开始测试录音权限...');
            updateStatus('正在请求录音权限...', 'info');

            try {
                // 检测WebView环境
                const isWebView = /Android.*wv\)|.*WebView.*Android|WebView|wv/i.test(navigator.userAgent);
                log(`环境检测: ${isWebView ? 'WebView' : '普通浏览器'}`);

                // 请求麦克风权限，WebView使用简化配置
                const constraints = isWebView ? {
                    audio: true
                } : {
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    }
                };

                log('请求权限配置: ' + JSON.stringify(constraints));

                const stream = await navigator.mediaDevices.getUserMedia(constraints);

                log('✅ 录音权限获取成功！');
                log(`音频轨道数量: ${stream.getAudioTracks().length}`);

                // 检查音频轨道状态
                const audioTrack = stream.getAudioTracks()[0];
                if (audioTrack) {
                    log(`音频轨道状态: ${audioTrack.readyState}`);
                    log(`音频轨道设置: ${JSON.stringify(audioTrack.getSettings())}`);
                }

                updateStatus('录音权限获取成功！可以开始录音', 'success');

                // 启用录音按钮
                document.getElementById('startRecordBtn').disabled = false;

                // 停止流（我们只是测试权限）
                stream.getTracks().forEach(track => track.stop());

            } catch (error) {
                log(`❌ 录音权限获取失败: ${error.name} - ${error.message}`);
                updateStatus(`录音权限获取失败: ${error.message}`, 'error');

                // 详细错误分析
                if (error.name === 'NotAllowedError') {
                    log('🔍 错误分析: 权限被拒绝');
                    log('解决方案: 1. 检查应用是否有麦克风权限 2. 检查WebView权限配置');
                } else if (error.name === 'NotFoundError') {
                    log('🔍 错误分析: 未找到音频输入设备');
                    log('解决方案: 检查设备是否有麦克风硬件');
                } else if (error.name === 'NotSupportedError') {
                    log('🔍 错误分析: 浏览器不支持录音功能');
                    log('解决方案: 更新WebView版本或检查API支持');
                } else if (error.name === 'NotReadableError') {
                    log('🔍 错误分析: 无法访问音频设备（常见WebView问题）');
                    log('解决方案: 1. 添加MODIFY_AUDIO_SETTINGS权限 2. 检查硬件特性声明 3. 确保WebView权限正确配置');
                    log('详细配置请参考: https://your-domain.com/document/webview-setup.md');
                } else {
                    log(`🔍 未知错误: ${error.name}`);
                }
            }
        }

        async function startRecording() {
            log('开始录音...');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: true
                });

                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    log(`录音完成，文件大小: ${audioBlob.size} 字节`);
                    updateStatus('录音完成', 'success');

                    // 停止所有音频轨道
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                log('✅ 录音已开始');
                updateStatus('正在录音...', 'info');

                // 更新按钮状态
                document.getElementById('startRecordBtn').disabled = true;
                document.getElementById('stopRecordBtn').disabled = false;

            } catch (error) {
                log(`❌ 开始录音失败: ${error.name} - ${error.message}`);
                updateStatus(`开始录音失败: ${error.message}`, 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                log('停止录音');

                // 更新按钮状态
                document.getElementById('startRecordBtn').disabled = false;
                document.getElementById('stopRecordBtn').disabled = true;
            }
        }

        function checkSystemInfo() {
            log('=== 系统信息检测 ===');
            log('用户代理: ' + navigator.userAgent);

            // WebView检测
            const isWebView = /Android.*wv\)|.*WebView.*Android|WebView|wv/i.test(navigator.userAgent);
            log(`WebView环境: ${isWebView ? '是' : '否'}`);

            // API支持检测
            log(`navigator.mediaDevices: ${!!navigator.mediaDevices}`);
            log(`getUserMedia: ${!!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)}`);
            log(`MediaRecorder: ${!!window.MediaRecorder}`);

            // 权限API检测
            log(`Permissions API: ${!!navigator.permissions}`);

            // 安全上下文检测
            log(`安全上下文 (HTTPS): ${window.isSecureContext}`);
            log(`协议: ${window.location.protocol}`);

            // Chrome版本检测（WebView基于Chrome）
            const chromeMatch = navigator.userAgent.match(/Chrome\/(\d+)/);
            if (chromeMatch) {
                log(`Chrome版本: ${chromeMatch[1]}`);
            }

            log('=== 检测完成 ===');
        }

        async function checkPermissionStatus() {
            if (!navigator.permissions) {
                log('浏览器不支持权限查询API');
                return;
            }

            try {
                const result = await navigator.permissions.query({ name: 'microphone' });
                log(`麦克风权限状态: ${result.state}`);

                result.addEventListener('change', () => {
                    log(`权限状态变更为: ${result.state}`);
                });
            } catch (error) {
                log(`权限查询失败: ${error.message}`);
            }
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function () {
            log('页面加载完成');

            // 系统信息检测
            checkSystemInfo();

            // 权限状态检查
            checkPermissionStatus();

            // 检查浏览器支持
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                log('❌ 浏览器不支持 getUserMedia API');
                updateStatus('浏览器不支持录音功能', 'error');
                document.getElementById('testBtn').disabled = true;
            } else {
                log('✅ 浏览器支持 getUserMedia API');
            }
        });
    </script>
</body>

</html>