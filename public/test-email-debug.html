<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚®ä»¶å‘é€è°ƒè¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 1rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 1rem;
        }
        button:hover {
            background: #0056CC;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 2rem;
            padding: 1rem;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“§ é‚®ä»¶å‘é€è°ƒè¯•å·¥å…·</h1>
        
        <div class="form-group">
            <label for="email">æµ‹è¯•é‚®ç®±åœ°å€ï¼š</label>
            <input type="email" id="email" placeholder="è¾“å…¥è¦æµ‹è¯•çš„é‚®ç®±åœ°å€" required>
        </div>
        
        <div class="form-group">
            <label for="api">é€‰æ‹© APIï¼š</label>
            <select id="api">
                <option value="send-verification-code">å•ç‹¬çš„å‘é€éªŒè¯ç  API</option>
                <option value="unified-auth">ç»Ÿä¸€è®¤è¯ API</option>
            </select>
        </div>
        
        <button onclick="testEmailSending()" id="testBtn">å‘é€æµ‹è¯•é‚®ä»¶</button>
        <button onclick="testSimpleEmail()" id="simpleBtn">ç®€å•é‚®ä»¶æµ‹è¯•</button>
        <button onclick="checkResendConfig()" id="resendBtn">æ£€æŸ¥ Resend é…ç½®</button>
        <button onclick="checkEmailConfig()" id="configBtn">æ£€æŸ¥é‚®ä»¶é…ç½®</button>
        
        <div id="result"></div>
    </div>

    <script>
        async function testEmailSending() {
            const email = document.getElementById('email').value;
            const api = document.getElementById('api').value;
            const resultDiv = document.getElementById('result');
            const testBtn = document.getElementById('testBtn');
            
            if (!email) {
                showResult('è¯·è¾“å…¥é‚®ç®±åœ°å€', 'error');
                return;
            }
            
            testBtn.disabled = true;
            testBtn.textContent = 'å‘é€ä¸­...';
            
            try {
                let url, body;
                
                if (api === 'send-verification-code') {
                    url = '/api/send-verification-code';
                    body = { email };
                } else {
                    url = '/api/unified-auth';
                    body = { action: 'send_code', email };
                }
                
                console.log('å‘é€è¯·æ±‚:', { url, body });
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });
                
                const result = await response.json();
                
                console.log('å“åº”çŠ¶æ€:', response.status);
                console.log('å“åº”æ•°æ®:', result);
                
                if (response.ok) {
                    showResult(`âœ… é‚®ä»¶å‘é€æˆåŠŸï¼\n\nå“åº”æ•°æ®:\n${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    showResult(`âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼\n\nçŠ¶æ€ç : ${response.status}\né”™è¯¯ä¿¡æ¯: ${result.error || 'æœªçŸ¥é”™è¯¯'}\n\nå®Œæ•´å“åº”:\n${JSON.stringify(result, null, 2)}`, 'error');
                }
            } catch (error) {
                console.error('è¯·æ±‚é”™è¯¯:', error);
                showResult(`âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼\n\né”™è¯¯ä¿¡æ¯: ${error.message}\n\nè¯·æ£€æŸ¥:\n1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n2. API æœåŠ¡æ˜¯å¦è¿è¡Œ\n3. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰æ›´å¤šé”™è¯¯ä¿¡æ¯`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'å‘é€æµ‹è¯•é‚®ä»¶';
            }
        }
        
        async function testSimpleEmail() {
            const email = document.getElementById('email').value;
            const resultDiv = document.getElementById('result');
            const simpleBtn = document.getElementById('simpleBtn');
            
            if (!email) {
                showResult('è¯·è¾“å…¥é‚®ç®±åœ°å€', 'error');
                return;
            }
            
            simpleBtn.disabled = true;
            simpleBtn.textContent = 'å‘é€ä¸­...';
            
            try {
                console.log('å‘é€ç®€å•æµ‹è¯•é‚®ä»¶:', { email });
                
                const response = await fetch('/api/test-email-simple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        email: email,
                        testType: 'default'
                    })
                });
                
                const result = await response.json();
                
                console.log('ç®€å•æµ‹è¯•å“åº”çŠ¶æ€:', response.status);
                console.log('ç®€å•æµ‹è¯•å“åº”æ•°æ®:', result);
                
                if (response.ok) {
                    showResult(`âœ… ç®€å•é‚®ä»¶æµ‹è¯•æˆåŠŸï¼\n\næµ‹è¯•éªŒè¯ç : ${result.testCode}\né‚®ä»¶ID: ${result.emailId}\n\nå®Œæ•´å“åº”:\n${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    showResult(`âŒ ç®€å•é‚®ä»¶æµ‹è¯•å¤±è´¥ï¼\n\nçŠ¶æ€ç : ${response.status}\né”™è¯¯ä¿¡æ¯: ${result.error || 'æœªçŸ¥é”™è¯¯'}\n\nè°ƒè¯•ä¿¡æ¯:\n${JSON.stringify(result.debug || {}, null, 2)}\n\nResend é”™è¯¯:\n${JSON.stringify(result.resendError || {}, null, 2)}`, 'error');
                }
            } catch (error) {
                console.error('ç®€å•æµ‹è¯•è¯·æ±‚é”™è¯¯:', error);
                showResult(`âŒ ç®€å•é‚®ä»¶æµ‹è¯•è¯·æ±‚å¤±è´¥ï¼\n\né”™è¯¯ä¿¡æ¯: ${error.message}`, 'error');
            } finally {
                simpleBtn.disabled = false;
                simpleBtn.textContent = 'ç®€å•é‚®ä»¶æµ‹è¯•';
            }
        }
        
        async function checkResendConfig() {
            const resultDiv = document.getElementById('result');
            const resendBtn = document.getElementById('resendBtn');
            
            resendBtn.disabled = true;
            resendBtn.textContent = 'æ£€æŸ¥ä¸­...';
            
            try {
                const response = await fetch('/api/test-resend-config');
                const result = await response.json();
                
                console.log('Resend é…ç½®æ£€æŸ¥ç»“æœ:', result);
                
                let configInfo = 'ğŸ” Resend API é…ç½®æ£€æŸ¥ç»“æœ:\n\n';
                
                if (result.hasApiKey) {
                    configInfo += `âœ… API å¯†é’¥: å·²è®¾ç½® (${result.apiKeyPrefix})\n`;
                    configInfo += `ğŸ“ å¯†é’¥é•¿åº¦: ${result.apiKeyLength} å­—ç¬¦\n\n`;
                } else {
                    configInfo += `âŒ API å¯†é’¥: æœªè®¾ç½®\n\n`;
                }
                
                if (result.testEmail) {
                    if (result.testEmail.success) {
                        configInfo += `âœ… æµ‹è¯•é‚®ä»¶å‘é€: æˆåŠŸ\n`;
                        configInfo += `ğŸ“§ é‚®ä»¶ID: ${result.testEmail.result?.id || 'æœªçŸ¥'}\n\n`;
                    } else {
                        configInfo += `âŒ æµ‹è¯•é‚®ä»¶å‘é€: å¤±è´¥ (çŠ¶æ€ç : ${result.testEmail.status})\n`;
                        configInfo += `é”™è¯¯ä¿¡æ¯: ${result.testEmail.error || 'æœªçŸ¥é”™è¯¯'}\n\n`;
                    }
                }
                
                if (result.domains) {
                    configInfo += `ğŸ“‹ å·²é…ç½®åŸŸå:\n`;
                    if (result.domains.data && result.domains.data.length > 0) {
                        result.domains.data.forEach(domain => {
                            configInfo += `  - ${domain.name} (çŠ¶æ€: ${domain.status})\n`;
                        });
                    } else {
                        configInfo += `  æ— è‡ªå®šä¹‰åŸŸåï¼Œä½¿ç”¨é»˜è®¤åŸŸå\n`;
                    }
                    configInfo += '\n';
                }
                
                if (result.recommendations) {
                    configInfo += 'ğŸ’¡ å»ºè®®:\n';
                    result.recommendations.forEach((rec, index) => {
                        configInfo += `${rec}\n`;
                    });
                }
                
                showResult(configInfo, result.hasApiKey ? 'success' : 'error');
                
            } catch (error) {
                console.error('æ£€æŸ¥ Resend é…ç½®é”™è¯¯:', error);
                showResult(`âŒ æ£€æŸ¥ Resend é…ç½®å¤±è´¥ï¼\n\né”™è¯¯ä¿¡æ¯: ${error.message}`, 'error');
            } finally {
                resendBtn.disabled = false;
                resendBtn.textContent = 'æ£€æŸ¥ Resend é…ç½®';
            }
        }

        async function checkEmailConfig() {
            const resultDiv = document.getElementById('result');
            const configBtn = document.getElementById('configBtn');
            
            configBtn.disabled = true;
            configBtn.textContent = 'æ£€æŸ¥ä¸­...';
            
            try {
                // æ£€æŸ¥é‚®ä»¶é…ç½®
                const configResponse = await fetch('/config/emailConfig.js');
                const configText = await configResponse.text();
                
                // æå–å…³é”®é…ç½®ä¿¡æ¯
                const fromMatch = configText.match(/FROM:\s*['"`]([^'"`]+)['"`]/);
                const nameMatch = configText.match(/NAME:\s*['"`]([^'"`]+)['"`]/);
                
                let configInfo = 'ğŸ“‹ é‚®ä»¶é…ç½®ä¿¡æ¯:\n\n';
                configInfo += `å‘ä»¶äººé‚®ç®±: ${fromMatch ? fromMatch[1] : 'æœªæ‰¾åˆ°'}\n`;
                configInfo += `å‘ä»¶äººåç§°: ${nameMatch ? nameMatch[1] : 'æœªæ‰¾åˆ°'}\n`;
                configInfo += `å®Œæ•´å‘ä»¶äººæ ¼å¼: ${nameMatch && fromMatch ? `${nameMatch[1]} <${fromMatch[1]}>` : 'æœªå®Œæ•´'}\n\n`;
                
                // æ£€æŸ¥ç¯å¢ƒå˜é‡ï¼ˆé€šè¿‡å‘é€ä¸€ä¸ªæµ‹è¯•è¯·æ±‚ï¼‰
                const testResponse = await fetch('/api/send-verification-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: 'test@example.com' })
                });
                
                const testResult = await testResponse.json();
                
                if (testResult.error && testResult.error.includes('æœåŠ¡é…ç½®é”™è¯¯')) {
                    configInfo += 'âŒ RESEND_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®æˆ–æ— æ•ˆ\n';
                } else {
                    configInfo += 'âœ… RESEND_API_KEY ç¯å¢ƒå˜é‡å·²è®¾ç½®\n';
                }
                
                configInfo += '\nğŸ” å»ºè®®æ£€æŸ¥é¡¹ç›®:\n';
                configInfo += '1. Vercel ç¯å¢ƒå˜é‡ä¸­æ˜¯å¦æ­£ç¡®è®¾ç½®äº† RESEND_API_KEY\n';
                configInfo += '2. Resend è´¦æˆ·æ˜¯å¦æœ‰æ•ˆä¸”æœ‰å‘é€é¢åº¦\n';
                configInfo += '3. å‘ä»¶äººé‚®ç®±åŸŸåæ˜¯å¦å·²åœ¨ Resend ä¸­éªŒè¯\n';
                configInfo += '4. é‚®ä»¶æ˜¯å¦è¢«æ”¶ä»¶äººçš„åƒåœ¾é‚®ä»¶è¿‡æ»¤å™¨æ‹¦æˆª\n';
                
                showResult(configInfo, 'success');
                
            } catch (error) {
                console.error('æ£€æŸ¥é…ç½®é”™è¯¯:', error);
                showResult(`âŒ æ£€æŸ¥é…ç½®å¤±è´¥ï¼\n\né”™è¯¯ä¿¡æ¯: ${error.message}`, 'error');
            } finally {
                configBtn.disabled = false;
                configBtn.textContent = 'æ£€æŸ¥é‚®ä»¶é…ç½®';
            }
        }
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = `result ${type}`;
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥é…ç½®
        window.addEventListener('load', () => {
            checkEmailConfig();
        });
    </script>
</body>
</html>