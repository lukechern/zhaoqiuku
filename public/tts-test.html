<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS æµ‹è¯•é¡µé¢ - æ‰¾ç§‹è£¤</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        .test-container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--background);
            border-radius: 8px;
        }
        
        .test-input {
            width: 100%;
            padding: 12px;
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        
        .test-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 1rem;
            margin-bottom: 0.5rem;
            transition: background 0.2s ease;
        }
        
        .test-btn:hover {
            background: var(--primary-dark);
        }
        
        .test-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }
        
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        
        .status.success {
            background: rgba(72, 187, 120, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .status.error {
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }
        
        .status.info {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .config-display {
            background: var(--surface-light);
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>TTS æµ‹è¯•é¡µé¢</h1>
            <p class="subtitle">æµ‹è¯• Azure Speech Service æ–‡æœ¬è½¬è¯­éŸ³åŠŸèƒ½</p>
        </header>

        <div class="test-container">
            <!-- é…ç½®çŠ¶æ€ -->
            <div class="test-section">
                <h3>é…ç½®çŠ¶æ€</h3>
                <div id="configStatus" class="status info">æ­£åœ¨æ£€æŸ¥é…ç½®...</div>
                <button id="debugBtn" class="test-btn">è¯¦ç»†è°ƒè¯•</button>
                <button id="pathTestBtn" class="test-btn">è·¯å¾„æµ‹è¯•</button>
                <div id="configDisplay" class="config-display"></div>
            </div>

            <!-- æ–‡æœ¬æµ‹è¯• -->
            <div class="test-section">
                <h3>æ–‡æœ¬æœ—è¯»æµ‹è¯•</h3>
                <textarea 
                    id="testText" 
                    class="test-input" 
                    rows="3" 
                    placeholder="è¾“å…¥è¦æœ—è¯»çš„æ–‡æœ¬...">ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªTTSæµ‹è¯•ã€‚æ¬¢è¿ä½¿ç”¨æ‰¾ç§‹è£¤AIè¯­éŸ³å¯»ç‰©åŠ©æ‰‹ï¼</textarea>
                <button id="speakBtn" class="test-btn">å¼€å§‹æœ—è¯»</button>
                <button id="stopBtn" class="test-btn" disabled>åœæ­¢æœ—è¯»</button>
                <div id="speakStatus" class="status info" style="display: none;"></div>
            </div>

            <!-- APIå“åº”æ¨¡æ‹Ÿæµ‹è¯• -->
            <div class="test-section">
                <h3>APIå“åº”æ¨¡æ‹Ÿæµ‹è¯•</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    æ¨¡æ‹ŸçœŸå®çš„APIå“åº”æ•°æ®ï¼Œæµ‹è¯•è‡ªåŠ¨æœ—è¯»åŠŸèƒ½
                </p>
                <button id="testApiResponse1" class="test-btn">æµ‹è¯•å­˜æ”¾ç‰©å“</button>
                <button id="testApiResponse2" class="test-btn">æµ‹è¯•æŸ¥æ‰¾ç‰©å“</button>
                <button id="testApiResponse3" class="test-btn">æµ‹è¯•é”™è¯¯å“åº”</button>
                <div id="apiTestStatus" class="status info" style="display: none;"></div>
            </div>

            <!-- è¿”å›ä¸»é¡µ -->
            <div class="test-section">
                <a href="index.html" class="test-btn" style="text-decoration: none; display: inline-block;">è¿”å›ä¸»é¡µ</a>
            </div>
        </div>
    </div>

    <script src="../config/ttsConfit.js"></script>
    <script type="module">
        import { TTSService } from './js/tts-service.js';

        let ttsService;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // ç­‰å¾…é…ç½®åŠ è½½
            await new Promise(resolve => setTimeout(resolve, 100));
            
            ttsService = new TTSService();
            updateConfigStatus();
            setupEventListeners();
        });

        async function updateConfigStatus() {
            const statusEl = document.getElementById('configStatus');
            const displayEl = document.getElementById('configDisplay');
            
            // æµ‹è¯•TTS APIæ˜¯å¦å¯ç”¨
            try {
                const testResponse = await fetch('/api/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: 'æµ‹è¯•' })
                });
                
                if (testResponse.ok) {
                    statusEl.className = 'status success';
                    statusEl.textContent = 'âœ… TTSæœåŠ¡APIå¯ç”¨ï¼Œåç«¯é…ç½®æ­£å¸¸';
                } else {
                    const errorData = await testResponse.json().catch(() => ({}));
                    statusEl.className = 'status error';
                    statusEl.textContent = `âŒ TTSæœåŠ¡APIé”™è¯¯ (${testResponse.status}): ${errorData.error || 'Unknown error'}`;
                    
                    // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                    displayEl.textContent = JSON.stringify(errorData, null, 2);
                    return;
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ æ— æ³•è¿æ¥åˆ°TTSæœåŠ¡API: ' + error.message;
            }

            // æ˜¾ç¤ºå‰ç«¯é…ç½®ä¿¡æ¯
            const config = { ...window.ttsConfig };
            displayEl.textContent = JSON.stringify(config, null, 2);
        }

        async function runDetailedDebug() {
            const statusEl = document.getElementById('configStatus');
            const displayEl = document.getElementById('configDisplay');
            
            statusEl.className = 'status info';
            statusEl.textContent = 'ğŸ” æ­£åœ¨è¿è¡Œè¯¦ç»†è°ƒè¯•...';
            
            try {
                const debugResponse = await fetch('/api/debug-tts');
                const debugData = await debugResponse.json();
                
                if (debugData.azureTest?.success) {
                    statusEl.className = 'status success';
                    statusEl.textContent = 'âœ… Azure Speech Serviceè¿æ¥æˆåŠŸï¼';
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'âŒ Azure Speech Serviceè¿æ¥å¤±è´¥';
                }
                
                displayEl.textContent = JSON.stringify(debugData, null, 2);
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ è°ƒè¯•APIè°ƒç”¨å¤±è´¥: ' + error.message;
                displayEl.textContent = error.stack || error.message;
            }
        }

        async function runPathTest() {
            const statusEl = document.getElementById('configStatus');
            const displayEl = document.getElementById('configDisplay');
            
            statusEl.className = 'status info';
            statusEl.textContent = 'ğŸ” æ­£åœ¨æµ‹è¯•Azure APIè·¯å¾„...';
            
            try {
                const pathResponse = await fetch('/api/test-azure-paths');
                const pathData = await pathResponse.json();
                
                if (pathData.successfulPath) {
                    statusEl.className = 'status success';
                    statusEl.textContent = `âœ… æ‰¾åˆ°æ­£ç¡®è·¯å¾„: ${pathData.successfulPath}`;
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'âŒ æœªæ‰¾åˆ°å¯ç”¨çš„APIè·¯å¾„';
                }
                
                displayEl.textContent = JSON.stringify(pathData, null, 2);
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ è·¯å¾„æµ‹è¯•å¤±è´¥: ' + error.message;
                displayEl.textContent = error.stack || error.message;
            }
        }

        function setupEventListeners() {
            const speakBtn = document.getElementById('speakBtn');
            const stopBtn = document.getElementById('stopBtn');
            const testText = document.getElementById('testText');
            const speakStatus = document.getElementById('speakStatus');

            // æœ—è¯»æŒ‰é’®
            speakBtn.addEventListener('click', async () => {
                const text = testText.value.trim();
                if (!text) {
                    showStatus(speakStatus, 'error', 'è¯·è¾“å…¥è¦æœ—è¯»çš„æ–‡æœ¬');
                    return;
                }

                speakBtn.disabled = true;
                stopBtn.disabled = false;
                showStatus(speakStatus, 'info', 'æ­£åœ¨æœ—è¯»...');

                try {
                    await ttsService.speak(text);
                    showStatus(speakStatus, 'success', 'æœ—è¯»å®Œæˆ');
                } catch (error) {
                    showStatus(speakStatus, 'error', 'æœ—è¯»å¤±è´¥: ' + error.message);
                } finally {
                    speakBtn.disabled = false;
                    stopBtn.disabled = true;
                }
            });

            // åœæ­¢æŒ‰é’®
            stopBtn.addEventListener('click', () => {
                ttsService.stop();
                speakBtn.disabled = false;
                stopBtn.disabled = true;
                showStatus(speakStatus, 'info', 'å·²åœæ­¢æœ—è¯»');
            });

            // è°ƒè¯•æŒ‰é’®
            document.getElementById('debugBtn').addEventListener('click', runDetailedDebug);
            
            // è·¯å¾„æµ‹è¯•æŒ‰é’®
            document.getElementById('pathTestBtn').addEventListener('click', runPathTest);

            // APIå“åº”æµ‹è¯•æŒ‰é’®
            document.getElementById('testApiResponse1').addEventListener('click', () => {
                testApiResponse({
                    transcript: "æŠŠæˆ‘çš„é’¥åŒ™æ”¾åœ¨å®¢å…èŒ¶å‡ ä¸Š",
                    business_result: {
                        success: true,
                        message: "å¥½çš„ï¼Œæˆ‘å·²ç»è®°å½•ä¸‹æ‚¨å°†é’¥åŒ™æ”¾åœ¨å®¢å…èŒ¶å‡ ä¸Šäº†ã€‚"
                    },
                    action: "put",
                    object: "é’¥åŒ™",
                    location: "å®¢å…èŒ¶å‡ "
                });
            });

            document.getElementById('testApiResponse2').addEventListener('click', () => {
                testApiResponse({
                    transcript: "æˆ‘çš„æ‰‹æœºåœ¨å“ªé‡Œ",
                    business_result: {
                        success: true,
                        message: "æ ¹æ®è®°å½•ï¼Œæ‚¨çš„æ‰‹æœºåœ¨å§å®¤åºŠå¤´æŸœä¸Šã€‚"
                    },
                    action: "get",
                    object: "æ‰‹æœº",
                    location: "å§å®¤åºŠå¤´æŸœ"
                });
            });

            document.getElementById('testApiResponse3').addEventListener('click', () => {
                testApiResponse({
                    transcript: "æ‰¾ä¸åˆ°çš„ä¸œè¥¿",
                    business_result: {
                        success: false,
                        message: "æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„ç‰©å“è®°å½•ã€‚"
                    },
                    action: "get",
                    object: "æ‰¾ä¸åˆ°çš„ä¸œè¥¿"
                });
            });
        }

        async function testApiResponse(mockData) {
            const statusEl = document.getElementById('apiTestStatus');
            showStatus(statusEl, 'info', 'æ­£åœ¨æµ‹è¯•APIå“åº”æœ—è¯»...');

            try {
                await ttsService.autoReadResponse(mockData);
                showStatus(statusEl, 'success', 'âœ… APIå“åº”æœ—è¯»æµ‹è¯•å®Œæˆ');
            } catch (error) {
                showStatus(statusEl, 'error', 'âŒ APIå“åº”æœ—è¯»æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        function showStatus(element, type, message) {
            element.className = `status ${type}`;
            element.textContent = message;
            element.style.display = 'block';
        }
    </script>
</body>
</html>