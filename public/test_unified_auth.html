<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»Ÿä¸€è®¤è¯æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 1rem;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        .test-button:hover {
            background: #0056CC;
        }
        .result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 4px;
            background: #f8f9fa;
            border-left: 4px solid #007AFF;
        }
        .error {
            border-left-color: #FF3B30;
            background: #fff5f5;
        }
        .success {
            border-left-color: #34C759;
            background: #f0fff4;
        }
        input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 0.5rem 0;
        }
        .form-row {
            display: flex;
            gap: 1rem;
            align-items: end;
        }
        .form-row input {
            flex: 1;
        }
    </style>
</head>
<body>
    <h1>ç»Ÿä¸€è®¤è¯åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>1. å‘é€éªŒè¯ç æµ‹è¯•</h2>
        <input type="email" id="testEmail" placeholder="è¾“å…¥æµ‹è¯•é‚®ç®±" value="test@example.com">
        <button class="test-button" onclick="testSendCode()">å‘é€éªŒè¯ç </button>
        <div id="sendResult"></div>
    </div>

    <div class="test-section">
        <h2>2. éªŒè¯éªŒè¯ç æµ‹è¯•</h2>
        <div class="form-row">
            <input type="email" id="verifyEmail" placeholder="é‚®ç®±åœ°å€" value="test@example.com">
            <input type="text" id="verifyCode" placeholder="6ä½éªŒè¯ç " maxlength="6">
            <button class="test-button" onclick="testVerifyCode()">éªŒè¯éªŒè¯ç </button>
        </div>
        <div id="verifyResult"></div>
    </div>

    <div class="test-section">
        <h2>3. å®Œæ•´æµç¨‹æµ‹è¯•</h2>
        <p>æµ‹è¯•æ–°ç”¨æˆ·æ³¨å†Œå’Œè€ç”¨æˆ·ç™»å½•çš„å®Œæ•´æµç¨‹</p>
        <input type="email" id="flowEmail" placeholder="è¾“å…¥é‚®ç®±è¿›è¡Œå®Œæ•´æµ‹è¯•" value="flow-test@example.com">
        <button class="test-button" onclick="testCompleteFlow()">å¼€å§‹å®Œæ•´æµ‹è¯•</button>
        <div id="flowResult"></div>
    </div>

    <div class="test-section">
        <h2>4. é‚®ä»¶æ ¼å¼æµ‹è¯•</h2>
        <p>æµ‹è¯•é‚®ä»¶å‘é€æ ¼å¼ï¼Œç‰¹åˆ«æ˜¯å‘ä»¶äººæ˜¾ç¤ºåç§°</p>
        <input type="email" id="formatEmail" placeholder="è¾“å…¥é‚®ç®±æµ‹è¯•é‚®ä»¶æ ¼å¼" value="test@example.com">
        <button class="test-button" onclick="testEmailFormat()">æµ‹è¯•é‚®ä»¶æ ¼å¼</button>
        <div id="formatResult"></div>
    </div>

    <div class="test-section">
        <h2>5. å¿«é€Ÿé“¾æ¥</h2>
        <button class="test-button" onclick="window.open('auth.html', '_blank')">æ‰“å¼€ç»Ÿä¸€è®¤è¯é¡µé¢</button>
        <button class="test-button" onclick="window.open('index.html', '_blank')">æ‰“å¼€ä¸»é¡µé¢</button>
        <button class="test-button" onclick="window.open('test_register.html', '_blank')">æ‰“å¼€è°ƒè¯•å·¥å…·</button>
    </div>

    <script>
        async function testSendCode() {
            const email = document.getElementById('testEmail').value;
            const resultDiv = document.getElementById('sendResult');
            
            if (!email) {
                showResult(resultDiv, 'è¯·è¾“å…¥é‚®ç®±åœ°å€', 'error');
                return;
            }

            try {
                showResult(resultDiv, 'æ­£åœ¨å‘é€éªŒè¯ç ...', '');
                
                const response = await fetch('/api/unified-auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        action: 'send_code',
                        email: email 
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    const message = `âœ… å‘é€æˆåŠŸï¼

ç”¨æˆ·ç±»å‹: ${result.userType === 'new' ? 'æ–°ç”¨æˆ·' : 'ç°æœ‰ç”¨æˆ·'}
é‚®ä»¶ID: ${result.emailId}
æ¶ˆæ¯: ${result.message}

${result.userType === 'new' ? 
    'ğŸ‰ æ£€æµ‹åˆ°æ–°ç”¨æˆ·ï¼ŒéªŒè¯åå°†è‡ªåŠ¨æ³¨å†Œ' : 
    'ğŸ‘‹ æ¬¢è¿å›æ¥ï¼ŒéªŒè¯åå³å¯ç™»å½•'}`;
                    
                    showResult(resultDiv, message, 'success');
                } else {
                    showResult(resultDiv, `âŒ å‘é€å¤±è´¥ï¼š${result.error}`, 'error');
                }
            } catch (error) {
                showResult(resultDiv, `âŒ ç½‘ç»œé”™è¯¯ï¼š${error.message}`, 'error');
            }
        }

        async function testVerifyCode() {
            const email = document.getElementById('verifyEmail').value;
            const code = document.getElementById('verifyCode').value;
            const resultDiv = document.getElementById('verifyResult');
            
            if (!email || !code) {
                showResult(resultDiv, 'è¯·è¾“å…¥é‚®ç®±åœ°å€å’ŒéªŒè¯ç ', 'error');
                return;
            }

            try {
                showResult(resultDiv, 'æ­£åœ¨éªŒè¯...', '');
                
                const response = await fetch('/api/unified-auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        action: 'verify_code',
                        email: email,
                        code: code
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    const message = `âœ… éªŒè¯æˆåŠŸï¼

æ“ä½œç±»å‹: ${result.userType === 'new' ? 'æ³¨å†Œ' : 'ç™»å½•'}
ç”¨æˆ·ä¿¡æ¯:
- é‚®ç®±: ${result.user.email}
- ID: ${result.user.id}
- çŠ¶æ€: ${result.user.status}
- å·²éªŒè¯: ${result.user.isVerified ? 'æ˜¯' : 'å¦'}

è®¤è¯ä»¤ç‰Œ:
- è®¿é—®ä»¤ç‰Œ: ${result.tokens.accessToken.substring(0, 20)}...
- ä»¤ç‰Œç±»å‹: ${result.tokens.tokenType}
- æœ‰æ•ˆæœŸ: ${Math.round(result.tokens.expiresIn / 1000 / 60 / 60 / 24)}å¤©

${result.message}`;
                    
                    showResult(resultDiv, message, 'success');
                } else {
                    showResult(resultDiv, `âŒ éªŒè¯å¤±è´¥ï¼š${result.error}`, 'error');
                }
            } catch (error) {
                showResult(resultDiv, `âŒ ç½‘ç»œé”™è¯¯ï¼š${error.message}`, 'error');
            }
        }

        async function testCompleteFlow() {
            const email = document.getElementById('flowEmail').value;
            const resultDiv = document.getElementById('flowResult');
            
            if (!email) {
                showResult(resultDiv, 'è¯·è¾“å…¥é‚®ç®±åœ°å€', 'error');
                return;
            }

            try {
                showResult(resultDiv, 'å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•...', '');
                
                // æ­¥éª¤1: å‘é€éªŒè¯ç 
                showResult(resultDiv, 'æ­¥éª¤1: å‘é€éªŒè¯ç ...', '');
                const sendResponse = await fetch('/api/unified-auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        action: 'send_code',
                        email: email 
                    })
                });

                const sendResult = await sendResponse.json();
                
                if (!sendResponse.ok) {
                    showResult(resultDiv, `âŒ å‘é€éªŒè¯ç å¤±è´¥ï¼š${sendResult.error}`, 'error');
                    return;
                }

                const message = `ğŸ“§ å®Œæ•´æµç¨‹æµ‹è¯•ç»“æœ:

æ­¥éª¤1: âœ… éªŒè¯ç å‘é€æˆåŠŸ
- ç”¨æˆ·ç±»å‹: ${sendResult.userType === 'new' ? 'æ–°ç”¨æˆ·ï¼ˆå°†æ³¨å†Œï¼‰' : 'ç°æœ‰ç”¨æˆ·ï¼ˆå°†ç™»å½•ï¼‰'}
- é‚®ä»¶å·²å‘é€åˆ°: ${email}

æ­¥éª¤2: ç­‰å¾…æ‰‹åŠ¨éªŒè¯
- è¯·æŸ¥æ”¶é‚®ç®±ä¸­çš„éªŒè¯ç 
- åœ¨ä¸Šæ–¹"éªŒè¯éªŒè¯ç æµ‹è¯•"ä¸­è¾“å…¥éªŒè¯ç å®Œæˆæµ‹è¯•

æµç¨‹è¯´æ˜:
${sendResult.userType === 'new' ? 
    'â€¢ æ–°ç”¨æˆ·å°†åœ¨éªŒè¯åè‡ªåŠ¨æ³¨å†Œå¹¶ç™»å½•\nâ€¢ è´¦æˆ·çŠ¶æ€å°†è®¾ç½®ä¸ºactive\nâ€¢ ç”ŸæˆJWTè®¤è¯ä»¤ç‰Œ' : 
    'â€¢ ç°æœ‰ç”¨æˆ·éªŒè¯åç›´æ¥ç™»å½•\nâ€¢ ä¿æŒåŸæœ‰è´¦æˆ·çŠ¶æ€\nâ€¢ åˆ·æ–°JWTè®¤è¯ä»¤ç‰Œ'}`;
                
                showResult(resultDiv, message, 'success');
                
            } catch (error) {
                showResult(resultDiv, `âŒ æµ‹è¯•å¤±è´¥ï¼š${error.message}`, 'error');
            }
        }

        async function testEmailFormat() {
            const email = document.getElementById('formatEmail').value;
            const resultDiv = document.getElementById('formatResult');
            
            if (!email) {
                showResult(resultDiv, 'è¯·è¾“å…¥é‚®ç®±åœ°å€', 'error');
                return;
            }

            try {
                showResult(resultDiv, 'æ­£åœ¨å‘é€æµ‹è¯•é‚®ä»¶...', '');
                
                const response = await fetch('/api/test-email-format', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email })
                });

                const result = await response.json();
                
                if (response.ok) {
                    const message = `ğŸ“§ é‚®ä»¶æ ¼å¼æµ‹è¯•ç»“æœ:

âœ… æµ‹è¯•é‚®ä»¶å‘é€æˆåŠŸï¼

é‚®ä»¶é…ç½®:
- å‘ä»¶äººå§“å: ${result.emailConfig.fromName}
- å‘ä»¶äººé‚®ç®±: ${result.emailConfig.fromEmail}
- å®Œæ•´å‘ä»¶äºº: ${result.emailConfig.fullFrom}
- é‚®ä»¶ä¸»é¢˜: ${result.emailConfig.subject}

Resend API å“åº”:
- é‚®ä»¶ID: ${result.resendResponse.id}
- å‘ä»¶äºº: ${result.resendResponse.from}
- æ”¶ä»¶äºº: ${result.resendResponse.to}

ğŸ“¬ è¯·æ£€æŸ¥æ‚¨çš„é‚®ç®±ï¼Œç¡®è®¤å‘ä»¶äººæ˜¾ç¤ºæ˜¯å¦åŒ…å«å§“åï¼š
"${result.emailConfig.fromName}"

ğŸ”§ æ•…éšœæ’é™¤å»ºè®®:

Gmailç›¸å…³:
${result.troubleshooting.gmailTips.map((tip, i) => `${i + 1}. ${tip}`).join('\n')}

Resendé…ç½®:
${result.troubleshooting.resendTips.map((tip, i) => `${i + 1}. ${tip}`).join('\n')}

ğŸ“§ æµ‹è¯•çš„å‘ä»¶äººæ ¼å¼:
${result.emailConfig.testFormats ? result.emailConfig.testFormats.map(format => 
    `â€¢ ${format.name}: ${format.from}\n  ${format.description}`
).join('\n') : ''}

å½“å‰ä½¿ç”¨: ${result.emailConfig.fullFrom}`;
                    
                    showResult(resultDiv, message, 'success');
                } else {
                    showResult(resultDiv, `âŒ æµ‹è¯•å¤±è´¥ï¼š${result.error}`, 'error');
                }
            } catch (error) {
                showResult(resultDiv, `âŒ ç½‘ç»œé”™è¯¯ï¼š${error.message}`, 'error');
            }
        }

        function showResult(element, message, type) {
            element.innerHTML = `<pre>${message}</pre>`;
            element.className = `result ${type}`;
        }
    </script>
</body>
</html>