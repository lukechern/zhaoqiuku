<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†å²è®°å½•è°ƒè¯•é¡µé¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .debug-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .debug-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .auto-refresh {
            background: #28a745;
        }
        .auto-refresh:hover {
            background: #218838;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-unknown { background: #6c757d; }
    </style>
</head>
<body>
    <h1>ğŸ” å†å²è®°å½•åŠŸèƒ½è°ƒè¯•é¡µé¢</h1>
    
    <div class="debug-section">
        <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€æ€»è§ˆ</h2>
        <div id="system-status">
            <div><span class="status-indicator status-unknown"></span>è®¤è¯ç®¡ç†å™¨: æ£€æŸ¥ä¸­...</div>
            <div><span class="status-indicator status-unknown"></span>APIè¿æ¥: æ£€æŸ¥ä¸­...</div>
            <div><span class="status-indicator status-unknown"></span>ç”¨æˆ·ç™»å½•: æ£€æŸ¥ä¸­...</div>
            <div><span class="status-indicator status-unknown"></span>å†å²è®°å½•API: æ£€æŸ¥ä¸­...</div>
        </div>
        <button onclick="checkSystemStatus()" class="auto-refresh">åˆ·æ–°çŠ¶æ€</button>
    </div>
    
    <div class="debug-section">
        <h2>ğŸ” è®¤è¯çŠ¶æ€æ£€æŸ¥</h2>
        <button onclick="checkAuthManager()">æ£€æŸ¥è®¤è¯ç®¡ç†å™¨</button>
        <button onclick="checkUserLogin()">æ£€æŸ¥ç”¨æˆ·ç™»å½•</button>
        <button onclick="simulateLogin()">æ¨¡æ‹Ÿç™»å½•</button>
        <button onclick="clearAuth()">æ¸…é™¤è®¤è¯</button>
        <div id="auth-debug-result"></div>
    </div>
    
    <div class="debug-section">
        <h2>ğŸŒ APIè¿æ¥æµ‹è¯•</h2>
        <button onclick="testHealthApi()">å¥åº·æ£€æŸ¥API</button>
        <button onclick="testHistoryApi()">å†å²è®°å½•API</button>
        <button onclick="testHistoryApiWithMockAuth()">æµ‹è¯•API(æ¨¡æ‹Ÿè®¤è¯)</button>
        <div id="api-debug-result"></div>
    </div>
    
    <div class="debug-section">
        <h2>ğŸ“‹ å†å²è®°å½•åŠŸèƒ½æµ‹è¯•</h2>
        <button onclick="testHistoryManager()">æµ‹è¯•å†å²è®°å½•ç®¡ç†å™¨</button>
        <button onclick="openHistoryPage()">æ‰“å¼€å†å²è®°å½•é¡µé¢</button>
        <button onclick="openHistoryPageTest()">æ‰“å¼€å†å²è®°å½•é¡µé¢(æµ‹è¯•æ¨¡å¼)</button>
        <div id="history-debug-result"></div>
    </div>
    
    <div class="debug-section">
        <h2>ğŸ”§ ç¯å¢ƒä¿¡æ¯</h2>
        <button onclick="showEnvironmentInfo()">æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯</button>
        <div id="env-debug-result"></div>
    </div>

    <script>
        let autoRefreshInterval = null;

        // æ˜¾ç¤ºç»“æœçš„è¾…åŠ©å‡½æ•°
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="debug-result ${type}">${message}</div>`;
        }

        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatusIndicator(index, status) {
            const indicators = document.querySelectorAll('#system-status .status-indicator');
            if (indicators[index]) {
                indicators[index].className = `status-indicator status-${status}`;
            }
        }

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystemStatus() {
            console.log('æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...');
            
            // æ£€æŸ¥è®¤è¯ç®¡ç†å™¨
            const authManagerOk = !!window.authManager;
            updateStatusIndicator(0, authManagerOk ? 'ok' : 'error');
            document.querySelector('#system-status div:nth-child(1)').innerHTML = 
                `<span class="status-indicator status-${authManagerOk ? 'ok' : 'error'}"></span>è®¤è¯ç®¡ç†å™¨: ${authManagerOk ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}`;

            // æ£€æŸ¥APIè¿æ¥
            try {
                const response = await fetch('/api/health');
                const apiOk = response.ok;
                updateStatusIndicator(1, apiOk ? 'ok' : 'error');
                document.querySelector('#system-status div:nth-child(2)').innerHTML = 
                    `<span class="status-indicator status-${apiOk ? 'ok' : 'error'}"></span>APIè¿æ¥: ${apiOk ? 'æ­£å¸¸' : 'å¼‚å¸¸'}`;
            } catch (error) {
                updateStatusIndicator(1, 'error');
                document.querySelector('#system-status div:nth-child(2)').innerHTML = 
                    `<span class="status-indicator status-error"></span>APIè¿æ¥: å¼‚å¸¸ (${error.message})`;
            }

            // æ£€æŸ¥ç”¨æˆ·ç™»å½•
            const userLoggedIn = authManagerOk && window.authManager.isAuthenticated;
            updateStatusIndicator(2, userLoggedIn ? 'ok' : 'warning');
            document.querySelector('#system-status div:nth-child(3)').innerHTML = 
                `<span class="status-indicator status-${userLoggedIn ? 'ok' : 'warning'}"></span>ç”¨æˆ·ç™»å½•: ${userLoggedIn ? 'å·²ç™»å½•' : 'æœªç™»å½•'}`;

            // æ£€æŸ¥å†å²è®°å½•API
            if (userLoggedIn) {
                try {
                    const response = await fetch('/api/test-history?page=1&limit=1', {
                        headers: {
                            'Authorization': `Bearer test-token`
                        }
                    });
                    const historyApiOk = response.ok;
                    updateStatusIndicator(3, historyApiOk ? 'ok' : 'error');
                    document.querySelector('#system-status div:nth-child(4)').innerHTML = 
                        `<span class="status-indicator status-${historyApiOk ? 'ok' : 'error'}"></span>å†å²è®°å½•API: ${historyApiOk ? 'æ­£å¸¸' : 'å¼‚å¸¸'}`;
                } catch (error) {
                    updateStatusIndicator(3, 'error');
                    document.querySelector('#system-status div:nth-child(4)').innerHTML = 
                        `<span class="status-indicator status-error"></span>å†å²è®°å½•API: å¼‚å¸¸ (${error.message})`;
                }
            } else {
                updateStatusIndicator(3, 'warning');
                document.querySelector('#system-status div:nth-child(4)').innerHTML = 
                    `<span class="status-indicator status-warning"></span>å†å²è®°å½•API: éœ€è¦ç™»å½•`;
            }
        }

        // æ£€æŸ¥è®¤è¯ç®¡ç†å™¨
        function checkAuthManager() {
            try {
                const result = {
                    exists: !!window.authManager,
                    isAuthenticated: window.authManager ? window.authManager.isAuthenticated : false,
                    user: window.authManager ? window.authManager.user : null,
                    tokens: window.authManager ? !!window.authManager.tokens : false,
                    storageKeys: window.authManager ? window.authManager.storageKeys : null
                };

                showResult('auth-debug-result', 
                    `è®¤è¯ç®¡ç†å™¨çŠ¶æ€:\n${JSON.stringify(result, null, 2)}`, 
                    result.exists ? 'success' : 'error'
                );
            } catch (error) {
                showResult('auth-debug-result', 
                    `æ£€æŸ¥è®¤è¯ç®¡ç†å™¨å¤±è´¥: ${error.message}`, 
                    'error'
                );
            }
        }

        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        function checkUserLogin() {
            try {
                if (!window.authManager) {
                    showResult('auth-debug-result', 'è®¤è¯ç®¡ç†å™¨æœªåŠ è½½', 'error');
                    return;
                }

                const authState = window.authManager.getAuthState();
                showResult('auth-debug-result', 
                    `ç”¨æˆ·ç™»å½•çŠ¶æ€:\n${JSON.stringify(authState, null, 2)}`, 
                    authState.isAuthenticated ? 'success' : 'warning'
                );
            } catch (error) {
                showResult('auth-debug-result', 
                    `æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€å¤±è´¥: ${error.message}`, 
                    'error'
                );
            }
        }

        // æ¨¡æ‹Ÿç™»å½•
        function simulateLogin() {
            try {
                if (!window.authManager) {
                    showResult('auth-debug-result', 'è®¤è¯ç®¡ç†å™¨æœªåŠ è½½ï¼Œæ— æ³•æ¨¡æ‹Ÿç™»å½•', 'error');
                    return;
                }

                const mockAuthData = {
                    user: {
                        id: 'debug-user-' + Date.now(),
                        email: 'debug@test.com'
                    },
                    tokens: {
                        accessToken: 'debug-access-token-' + Date.now(),
                        refreshToken: 'debug-refresh-token-' + Date.now(),
                        tokenType: 'Bearer'
                    }
                };

                window.authManager.saveAuthState(mockAuthData);
                showResult('auth-debug-result', 
                    `æ¨¡æ‹Ÿç™»å½•æˆåŠŸ:\n${JSON.stringify(mockAuthData, null, 2)}`, 
                    'success'
                );
                
                // æ›´æ–°ç³»ç»ŸçŠ¶æ€
                setTimeout(checkSystemStatus, 100);
            } catch (error) {
                showResult('auth-debug-result', 
                    `æ¨¡æ‹Ÿç™»å½•å¤±è´¥: ${error.message}`, 
                    'error'
                );
            }
        }

        // æ¸…é™¤è®¤è¯
        function clearAuth() {
            try {
                if (!window.authManager) {
                    showResult('auth-debug-result', 'è®¤è¯ç®¡ç†å™¨æœªåŠ è½½', 'error');
                    return;
                }

                window.authManager.clearAuthState();
                showResult('auth-debug-result', 'è®¤è¯çŠ¶æ€å·²æ¸…é™¤', 'success');
                
                // æ›´æ–°ç³»ç»ŸçŠ¶æ€
                setTimeout(checkSystemStatus, 100);
            } catch (error) {
                showResult('auth-debug-result', 
                    `æ¸…é™¤è®¤è¯å¤±è´¥: ${error.message}`, 
                    'error'
                );
            }
        }

        // æµ‹è¯•å¥åº·æ£€æŸ¥API
        async function testHealthApi() {
            try {
                showResult('api-debug-result', 'æ­£åœ¨æµ‹è¯•å¥åº·æ£€æŸ¥API...', 'info');
                
                const response = await fetch('/api/health');
                const data = await response.json();
                
                showResult('api-debug-result', 
                    `å¥åº·æ£€æŸ¥APIæµ‹è¯•ç»“æœ:\nçŠ¶æ€: ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`, 
                    response.ok ? 'success' : 'error'
                );
            } catch (error) {
                showResult('api-debug-result', 
                    `å¥åº·æ£€æŸ¥APIæµ‹è¯•å¤±è´¥: ${error.message}`, 
                    'error'
                );
            }
        }

        // æµ‹è¯•å†å²è®°å½•API
        async function testHistoryApi() {
            try {
                if (!window.authManager || !window.authManager.isAuthenticated) {
                    showResult('api-debug-result', 'éœ€è¦å…ˆç™»å½•æ‰èƒ½æµ‹è¯•å†å²è®°å½•API', 'warning');
                    return;
                }

                showResult('api-debug-result', 'æ­£åœ¨æµ‹è¯•å†å²è®°å½•API...', 'info');
                
                const response = await fetch('/api/user/history?page=1&limit=5', {
                    headers: {
                        'Content-Type': 'application/json',
                        ...window.authManager.getAuthHeaders()
                    }
                });
                
                const data = await response.json();
                
                showResult('api-debug-result', 
                    `å†å²è®°å½•APIæµ‹è¯•ç»“æœ:\nçŠ¶æ€: ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`, 
                    response.ok ? 'success' : 'error'
                );
            } catch (error) {
                showResult('api-debug-result', 
                    `å†å²è®°å½•APIæµ‹è¯•å¤±è´¥: ${error.message}`, 
                    'error'
                );
            }
        }

        // æµ‹è¯•å†å²è®°å½•API(æ¨¡æ‹Ÿè®¤è¯)
        async function testHistoryApiWithMockAuth() {
            try {
                showResult('api-debug-result', 'æ­£åœ¨æµ‹è¯•å†å²è®°å½•API(æ¨¡æ‹Ÿè®¤è¯)...', 'info');
                
                const response = await fetch('/api/test-history?page=1&limit=5', {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer mock-token-for-testing'
                    }
                });
                
                const data = await response.json();
                
                showResult('api-debug-result', 
                    `æµ‹è¯•å†å²è®°å½•APIç»“æœ:\nçŠ¶æ€: ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`, 
                    response.ok ? 'success' : 'error'
                );
            } catch (error) {
                showResult('api-debug-result', 
                    `æµ‹è¯•å†å²è®°å½•APIå¤±è´¥: ${error.message}`, 
                    'error'
                );
            }
        }

        // æµ‹è¯•å†å²è®°å½•ç®¡ç†å™¨
        function testHistoryManager() {
            try {
                const result = {
                    exists: !!window.historyManager,
                    currentPage: window.historyManager ? window.historyManager.currentPage : null,
                    isLoading: window.historyManager ? window.historyManager.isLoading : null,
                    hasMore: window.historyManager ? window.historyManager.hasMore : null,
                    recordsCount: window.historyManager ? window.historyManager.records.length : null,
                    testMode: window.historyManager ? window.historyManager.testMode : null
                };

                showResult('history-debug-result', 
                    `å†å²è®°å½•ç®¡ç†å™¨çŠ¶æ€:\n${JSON.stringify(result, null, 2)}`, 
                    result.exists ? 'success' : 'error'
                );
            } catch (error) {
                showResult('history-debug-result', 
                    `æµ‹è¯•å†å²è®°å½•ç®¡ç†å™¨å¤±è´¥: ${error.message}`, 
                    'error'
                );
            }
        }

        // æ‰“å¼€å†å²è®°å½•é¡µé¢
        function openHistoryPage() {
            window.open('history.html', '_blank');
            showResult('history-debug-result', 'å†å²è®°å½•é¡µé¢å·²åœ¨æ–°çª—å£æ‰“å¼€', 'success');
        }

        // æ‰“å¼€å†å²è®°å½•é¡µé¢(æµ‹è¯•æ¨¡å¼)
        function openHistoryPageTest() {
            window.open('history.html?test=true', '_blank');
            showResult('history-debug-result', 'å†å²è®°å½•é¡µé¢(æµ‹è¯•æ¨¡å¼)å·²åœ¨æ–°çª—å£æ‰“å¼€', 'success');
        }

        // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        function showEnvironmentInfo() {
            const info = {
                userAgent: navigator.userAgent,
                url: window.location.href,
                timestamp: new Date().toISOString(),
                localStorage: {
                    length: localStorage.length,
                    keys: Object.keys(localStorage)
                },
                windowObjects: {
                    authManager: !!window.authManager,
                    historyManager: !!window.historyManager,
                    apiConfig: !!window.apiConfig
                }
            };

            showResult('env-debug-result', 
                `ç¯å¢ƒä¿¡æ¯:\n${JSON.stringify(info, null, 2)}`, 
                'info'
            );
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('è°ƒè¯•é¡µé¢åŠ è½½å®Œæˆ');
            
            // åŠ¨æ€åŠ è½½å¿…è¦çš„è„šæœ¬
            const scripts = [
                'js/api-config.js',
                'js/auth-manager.js'
            ];

            let loadedScripts = 0;
            scripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src + '?v=' + Date.now();
                script.onload = () => {
                    loadedScripts++;
                    console.log(`è„šæœ¬åŠ è½½å®Œæˆ: ${src} (${loadedScripts}/${scripts.length})`);
                    if (loadedScripts === scripts.length) {
                        console.log('æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆï¼Œå¼€å§‹ç³»ç»Ÿæ£€æŸ¥');
                        setTimeout(() => {
                            checkSystemStatus();
                        }, 500);
                    }
                };
                script.onerror = () => {
                    console.error('è„šæœ¬åŠ è½½å¤±è´¥:', src);
                };
                document.head.appendChild(script);
            });
        });
    </script>
</body>
</html>