<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>认证状态测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>认证状态测试页面</h1>
    
    <div class="test-section">
        <h2>当前状态</h2>
        <div id="currentStatus" class="status info">检查中...</div>
        <button onclick="checkCurrentState()">刷新状态</button>
        <button onclick="window.location.href='index.html'">返回主页</button>
    </div>
    
    <div class="test-section">
        <h2>测试操作</h2>
        <button onclick="simulateLogin()">模拟登录</button>
        <button onclick="clearAuthState()">清除认证状态</button>
        <button onclick="testPageRefresh()">测试页面刷新</button>
    </div>
    
    <div class="test-section">
        <h2>详细信息</h2>
        <pre id="detailInfo">加载中...</pre>
    </div>

    <script>
        // 加载必要的脚本
        const scripts = [
            'js/auth-manager.js',
            'js/state-sync.js'
        ];
        
        let loadedScripts = 0;
        scripts.forEach(src => {
            const script = document.createElement('script');
            script.src = src + '?v=' + Date.now();
            script.onload = () => {
                loadedScripts++;
                if (loadedScripts === scripts.length) {
                    setTimeout(checkCurrentState, 500);
                }
            };
            document.head.appendChild(script);
        });
        
        function checkCurrentState() {
            const statusDiv = document.getElementById('currentStatus');
            const detailDiv = document.getElementById('detailInfo');
            
            if (!window.authManager) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '认证管理器未加载';
                detailDiv.textContent = '错误：认证管理器未找到';
                return;
            }
            
            const authState = window.authManager.getAuthState();
            
            if (authState.isAuthenticated) {
                statusDiv.className = 'status success';
                statusDiv.textContent = `已登录：${authState.user.email}`;
            } else {
                statusDiv.className = 'status info';
                statusDiv.textContent = '未登录';
            }
            
            // 显示详细信息
            const detail = {
                认证状态: authState.isAuthenticated,
                用户信息: authState.user,
                登录时间: authState.loginTime ? new Date(parseInt(authState.loginTime)).toLocaleString() : null,
                Token存在: !!authState.tokens,
                LocalStorage: {
                    accessToken: !!localStorage.getItem('zhaoqiuku_access_token'),
                    refreshToken: !!localStorage.getItem('zhaoqiuku_refresh_token'),
                    userInfo: !!localStorage.getItem('zhaoqiuku_user_info')
                }
            };
            
            detailDiv.textContent = JSON.stringify(detail, null, 2);
        }
        
        function simulateLogin() {
            if (!window.authManager) {
                alert('认证管理器未加载');
                return;
            }
            
            const mockAuthData = {
                user: {
                    id: 'test-user-' + Date.now(),
                    email: 'test@example.com',
                    status: 'active',
                    isVerified: true
                },
                tokens: {
                    accessToken: 'test-access-token-' + Date.now(),
                    refreshToken: 'test-refresh-token-' + Date.now(),
                    tokenType: 'Bearer'
                }
            };
            
            window.authManager.saveAuthState(mockAuthData);
            setTimeout(checkCurrentState, 100);
            alert('模拟登录完成');
        }
        
        function clearAuthState() {
            if (!window.authManager) {
                alert('认证管理器未加载');
                return;
            }
            
            window.authManager.clearAuthState();
            setTimeout(checkCurrentState, 100);
            alert('认证状态已清除');
        }
        
        function testPageRefresh() {
            if (confirm('这将刷新页面以测试状态恢复，确定继续吗？')) {
                window.location.reload();
            }
        }
    </script>
</body>
</html>